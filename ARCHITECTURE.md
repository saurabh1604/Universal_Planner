# Universal Migration Planner - System Architecture

This document outlines the **Logical Architecture** of the Universal Migration Planner (UAMP). It illustrates how human intent is transformed into mathematical execution through an intelligent, schema-aware middleware layer.

## The 3-Layer Logic Flow

```mermaid
graph LR
    %% STYLING
    classDef user fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef context fill:#fff3e0,stroke:#e65100,stroke-width:2px;
    classDef intelligence fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px;
    classDef execution fill:#f3e5f5,stroke:#4a148c,stroke-width:2px;

    %% -----------------------------
    %% ZONE 1: INPUT & CONTEXT
    %% -----------------------------
    subgraph "Zone 1: Input & Reality"
        direction TB
        User([User]):::user
        RawData[(Raw CSV)]:::context

        Profiler[Schema Engine]:::context
        Passport[Data Passport]:::context

        User -->|Uploads| RawData
        RawData -->|Scans| Profiler
        Profiler -->|Generates| Passport
    end

    %% -----------------------------
    %% ZONE 2: INTELLIGENT MIDDLEWARE
    %% -----------------------------
    subgraph "Zone 2: The Agentic Brain"
        direction TB
        Chat[Chat Interface]:::intelligence
        Auditor[Auditor Agent]:::intelligence
        Architect[Architect Agent]:::intelligence
        Rules[(Constraint Store)]:::intelligence

        User -->|Natural Language| Chat
        Passport -.->|Injects Reality| Auditor
        Passport -.->|Injects Reality| Architect

        %% The Interaction Loop
        Chat <-->|Validation Loop| Auditor
        Auditor -->|Approved Request| Architect
        Architect -->|Generates CDL| Rules
    end

    %% -----------------------------
    %% ZONE 3: EXECUTION CORE
    %% -----------------------------
    subgraph "Zone 3: Mathematical Execution"
        direction TB
        Solver[Universal Solver]:::execution
        Schedule[Optimized Schedule]:::execution

        Rules -->|CDL Instructions| Solver
        RawData -->|Data Input| Solver
        Solver -->|Calculates| Schedule
    end

    %% FEEDBACK
    Schedule -.->|Visualize| User
```

## Core Components

### 1. Context Engine (The "Eyes")
*   **Purpose**: To ground the LLM in reality.
*   **Mechanism**: The **Schema Engine** profiles the uploaded data, creating a **Data Passport** (summary of columns, ranges, and unique values).
*   **Benefit**: Prevents hallucinations by ensuring agents only reference columns and values that actually exist.

### 2. Intelligent Middleware (The "Brain")
*   **The Auditor**: A gatekeeper that ensures requests are logical and unambiguous.
    *   *Example*: Fails "Start in Jan 2025" if "Blackout Jan 2025" exists.
*   **The Architect**: A translator that converts approved English requests into **Constraint Definition Language (CDL)**.
    *   *Feature*: Uses "Few-Shot Learning" to construct complex nested logic (e.g., `IMPLIES`, `AND`) and maps relative dates (e.g., "Next Month") to absolute indices.

### 3. Execution Core (The "Hands")
*   **Universal Solver**: A Google OR-Tools (CP-SAT) engine.
*   **Mechanism**: It is "blind" to business logic. It simply executes the mathematical instructions (CDL) generated by the Architect against the raw data.
